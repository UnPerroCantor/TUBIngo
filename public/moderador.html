<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Bingo Moderador</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .categoria { margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; }
    .categoria h2 { margin: 0 0 10px 0; font-size: 18px; color: #333; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
    .momento-btn {
      height: 80px; border: 1px solid #333; border-radius: 5px; cursor: pointer;
      background: #f9f9f9; padding: 5px; text-align: center; font-size: 13px;
      white-space: normal; word-wrap: break-word; display: flex; align-items: center; justify-content: center;
    }
    .momento-btn.seleccionado { background: #4caf50; color: white; font-weight: bold; }
    .momento-btn.usado { background: #bbb; color: #666; pointer-events: none; }
    #enviar { margin: 20px 10px 20px 0; padding: 10px 20px; font-size: 16px;
      background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #enviar:hover { background: #1976d2; }
    #enviar:disabled { background: #90caf9; cursor: not-allowed; }
    #log { margin-top: 30px; padding: 10px; background: #eee; border: 1px solid #ccc; border-radius: 5px; }
    .log-categoria { margin-bottom: 10px; }
    .log-categoria h3 { font-size: 15px; margin: 5px 0; }
    .chip { display: inline-block; background: #ddd; border-radius: 15px; padding: 5px 10px; margin: 3px; font-size: 13px; }
    .chip.editable { background: #ffc107; cursor: pointer; position: relative; }
    .chip.editable::after { content: "✖"; font-size: 12px; position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; padding: 2px; }
    #editarLog, #cancelarEdicion { margin-top: 10px; padding: 6px 12px; font-size: 14px; border: none; border-radius: 5px; cursor: pointer; }
    #editarLog { background: #ff5722; color: white; }
    #editarLog:hover { background: #e64a19; }
    #cancelarEdicion { background: #9e9e9e; color: white; display: none; }
    #cancelarEdicion:hover { background: #757575; }
  </style>
</head>
<body>
  <h1>Panel del Moderador</h1>
  <div id="categorias"></div>
  <button id="enviar">Enviar selección</button>

  <div id="log"><strong>Log de envíos:</strong></div>
  <button id="editarLog">Editar</button>
  <button id="cancelarEdicion">Cancelar</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let seleccionados = new Set();
    let momentosData = [];
    let categoriasLista = [];
    let logData = {};
    let editMode = false;
    let backupLog = null;

    async function cargarMomentos() {
      const res = await fetch("momentos.json");
      momentosData = await res.json();

      const porCategoria = {};
      momentosData.forEach(m => {
        if (!porCategoria[m.categoria]) porCategoria[m.categoria] = [];
        porCategoria[m.categoria].push(m);
      });
      categoriasLista = Object.keys(porCategoria);

      const contenedor = document.getElementById("categorias");
      for (const categoria of categoriasLista) {
        const bloque = document.createElement("div");
        bloque.className = "categoria";
        const titulo = document.createElement("h2");
        titulo.textContent = categoria;
        bloque.appendChild(titulo);

        const grid = document.createElement("div");
        grid.className = "grid";

        porCategoria[categoria].forEach(m => {
          const btn = document.createElement("div");
          btn.className = "momento-btn";
          btn.textContent = `${m.numero} - ${m.momento}`;
          btn.dataset.numero = m.numero;
          btn.dataset.categoria = m.categoria;

          btn.addEventListener("click", () => {
            if (seleccionados.has(m.numero)) {
              seleccionados.delete(m.numero);
              btn.classList.remove("seleccionado");
            } else {
              seleccionados.add(m.numero);
              btn.classList.add("seleccionado");
            }
          });

          grid.appendChild(btn);
        });

        bloque.appendChild(grid);
        contenedor.appendChild(bloque);
      }

      categoriasLista.forEach(cat => logData[cat] = []);
      actualizarLog();
    }

    function actualizarLog() {
      const log = document.getElementById("log");
      log.innerHTML = "<strong>Log de envíos:</strong>";

      for (const categoria of categoriasLista) {
        const bloque = document.createElement("div");
        bloque.className = "log-categoria";
        const titulo = document.createElement("h3");
        titulo.textContent = categoria;
        bloque.appendChild(titulo);

        logData[categoria].forEach((m, idx) => {
          const chip = document.createElement("span");
          chip.className = "chip";
          let texto = m.momento.length > 15 ? m.momento.slice(0, 15) + "…" : m.momento;
          chip.textContent = `${m.numero} - ${texto}`;

          if (editMode) {
            chip.classList.add("editable");
            chip.addEventListener("click", () => {
              logData[categoria].splice(idx, 1);
              // Rehabilitar botón en panel
              const btn = document.querySelector(`.momento-btn[data-numero="${m.numero}"]`);
              if (btn) btn.classList.remove("usado");
              actualizarLog();
            });
          }

          bloque.appendChild(chip);
        });

        log.appendChild(bloque);
      }
    }

    document.getElementById("enviar").addEventListener("click", () => {
      if (seleccionados.size > 0 && !editMode) {
        const momentosAEnviar = momentosData.filter(m => seleccionados.has(m.numero));
        socket.emit("momentos-anunciados", momentosAEnviar.map(m => m.numero));

        momentosAEnviar.forEach(m => {
          logData[m.categoria].push(m);
          document.querySelector(`.momento-btn[data-numero="${m.numero}"]`)
            .classList.add("usado");
        });

        actualizarLog();
        seleccionados.clear();
        document.querySelectorAll(".momento-btn.seleccionado")
          .forEach(btn => btn.classList.remove("seleccionado"));
      }
    });

    const btnEditar = document.getElementById("editarLog");
    const btnCancelar = document.getElementById("cancelarEdicion");

    btnEditar.addEventListener("click", () => {
      if (!editMode) {
        // Entrar en edición
        editMode = true;
        backupLog = JSON.parse(JSON.stringify(logData));
        btnEditar.textContent = "Guardar";
        btnCancelar.style.display = "inline-block";
        document.getElementById("enviar").disabled = true;
      } else {
        // Guardar cambios
        editMode = false;
        backupLog = null;
        btnEditar.textContent = "Editar";
        btnCancelar.style.display = "none";
        document.getElementById("enviar").disabled = false;

        // Rehabilitar botones eliminados
        const usados = new Set();
        categoriasLista.forEach(cat => {
          logData[cat].forEach(m => usados.add(m.numero));
        });
        document.querySelectorAll(".momento-btn").forEach(btn => {
          if (!usados.has(parseInt(btn.dataset.numero))) btn.classList.remove("usado");
        });
      }
      actualizarLog();
    });

    btnCancelar.addEventListener("click", () => {
      if (backupLog) {
        logData = JSON.parse(JSON.stringify(backupLog));
        backupLog = null;
      }
      editMode = false;
      btnEditar.textContent = "Editar";
      btnCancelar.style.display = "none";
      document.getElementById("enviar").disabled = false;
      actualizarLog();
    });

    cargarMomentos();
  </script>
</body>
</html>
